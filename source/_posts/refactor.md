---
title:最近重构的一点心得
date: 2017-08-13 21:38:31
categories: 技术博文
tags: [coding][refactor]
---

最近两周一直在做代码重构的工作，准备出2.0版本的ADAS程序。

程序员能有时间做重构，其实是一件幸运的事情。在很多公司，因为开发进度的压力，或者leader不太懂技术一般都不会给专门重构的时间，也不理解重构的重要性。如果员工觉得代码必须要重构，之后会显著提高开发速度，而Leader却不支持员工的做法时，某些技术大牛给的建议是：自己偷偷重构，不要告诉Leader。公司雇员工是最大程度来产出，既然确定暂时花一些时间来重构能显著增加之后的工作效率，那就不违背初衷。当然了，我是不赞成偷偷重构的。

程序员积累了越来越多的“技术负债”，越来越觉得深陷泥潭，脚步不再轻盈，举步维艰。而代码也逐渐失控，稍微一点修改就可能触发未知的错误。更糟糕的是，面对这种代码，程序员很可能会自甘堕落，破罐子破摔。之后写的代码能运行就可以，代码质量直线下降。最终的结果就是：自己写的代码自己都不愿意看。而重构是解决这些问题最好的方法，更棒的是：代码是越写越好的，自己对系统更加熟悉了，变成水平提高了。

这次重构本想是对某几个模块的算法进行改进。算法改进方面不谈，因为以前的技术负债太多，一周的时间花了不少时间填平以前挖的坑。包括：

1. 给系统加入了log系统。分级别输出的log让了解程序运行状态简单很多
2. 重写了图像的调试模块。保存的图像配合log让调试过程变得简单很多，效果比gdb好很多
3. 重写了参数输入模块，改成了Linux-style，可以有长短参数，并且加入了help
4. 新添加了许多防御性代码和测试的脚手架代码
5. 删除无用代码，抽离了一些公用方法

自己看以前的代码，觉得自己写的真烂。函数长长的参数，随处可见的重复代码，以magic code返回的函数，毫无错误处理，参数和返回值不检查等等等等。有时候有些责怪自己，为什么当时那么不负责任，以东拼西凑的态度写代码，以撞大运的心态让程序运行起来。更何况我们写的程序使用在自动驾驶上的，我自己心里都没底，怎么敢让车用。如果无人车用了我们的传感器，估计我以后连门都不敢出了，怕飞来横祸。

能感觉自己烂，也能说明自己成长了。审美是最难提高的，进化出嗅出坏代码味道的鼻子，也是需要不断修炼的。阅读其他人优秀的代码，多看书和实践，慢慢就能培养出这方面的能力来。

最近这一周也在抽空看《代码大全》，也有不少收获。那本书基本包含了写代码的方方面面，真的关于如何写代码的大全。编程大牛门总结了厚厚一本编程的实践指南，我现在也只能体会一小部分，自己还有太多不知道的。不懂为什么的实践准则，也没法真正实践到项目中。以前就读到过一句话：你从书中学到的大多数东西，都是你早就思考过或者体会过，只是书中给你点出来了。自己没有思考或者任何经验的东西，书中说了也不会有深刻体会。自己唯有多看，多写，多思考，才能领会更多。

重构完之后，自己写的代码勉强可以阅读了，也暂时不会害怕同事review代码。但今后审美提高了，估计看到现在的代码还是会吐。而且代码会慢慢腐烂，就像刚擦的窗户，刚擦完怎么都挺干净，用着用着自然就脏了。






